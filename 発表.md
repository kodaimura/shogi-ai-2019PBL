# 将棋AI

## 制作過程
* 6月18日〜7月9日  １手詰みプログラム
* 7月9日〜7月15日　 N手詰みプログラム
* 7月23日　　中間発表
* 8月1日〜9月17日　 将棋AI一号機　（エキスパートシステム）
* 9月17日〜10月7日　 改良
* 10月7日　 2014年版将棋AIと対戦
* 10月15日〜10月29日  棋譜データ収集
* 10月29日〜12月3日  将棋AI二号機　（機械学習）
* 12月10日 　後期中間発表
* 12月10日〜1月21日　　将棋AI三号機　（機械学習）
* 1月28日  最終発表

## 成果

### 将棋AI一号機
一号機は自分の知識を入れ込む手法で制作した。
10月7日（火）に2014年版将棋AIと2局、先輩と2局行った。
結果、VS2014年版では、2勝0敗。VS先輩では、1勝0敗であった。

### 将棋AI二号機
二号機は機械学習という手法で制作した。
将棋AI一号機と対戦し、勝利したがそれほど強くならなかった。

### 将棋AI三号機
三号機も機械学習で制作した。

まだ完成していない。
後から書く。


## 将棋AIの仕組み
将棋AI一号機、二号機、三号機ともに以下に記す構成、指し手選択の流れは同じである。
また、一般的な将棋AIも構成、指し手選択の流れは基本的に同じである。

## 構成
大きく分けると以下の三部構造となっている。
* 詰み判定部
* 探索部
* 盤面評価部

### 指し手選択の流れ
まず、詰み判定部で詰みがあるか判定し、詰む場合はその手を指し、詰まない場合はその局面における最善手を以下の手順で決める。初めに、探索部で現在の局面から数手先にあり得る盤面を全て生成する。
次に、生成した盤面を全て盤面評価部で評価し点数を付ける。最後に、MIN-MAXというアルゴリズムで点数を元にどの指し手で進めた局面が最も有利になるかで指し手を選ぶ。
おそらく一対一のオセロ、チェス、囲碁などのボードゲームも全てこの手順で指し手を選択していると考えられる。

より強い将棋AIを作るには、探索部で『より先の盤面を生成すること』盤面評価部で『より正確に局面に点数を付けること』が大切であ理、探索部をいかに高速化するか、局面の点数をどのように付けるかが将棋AIの強さを決める。

### 詰み判定部
制作した将棋AIに組み込んだのは３手詰みまで（１手詰みも含む）で、３手以内に詰む手があるか判定する。
詰み判定部に必要なものは、『王手判定』『詰み判定』である。
『王手判定』は、自分の全ての駒が次動ける位置のどこかに相手の王が居るかどうかで判定する。
『詰み判定』は、対象局面で王手かどうか、その王手を逃れる手があるかどうかで判定する。

### ３手詰み判定手順
現局面における全ての「王手」を生成
生成した「王手」を指した時の仮想盤面を生成
それぞれの仮想盤面における全ての「王手を逃れる手」を生成
生成した「王手を逃れる手」を指した時の仮想盤面を生成
それぞれの仮想盤面における「王手」を生成
生成した「王手」を指した時の盤面で詰みか判定

実際は、全ての王手を逃れる手について詰まないといけないが、説明が複雑になるため簡略化して説明している。
３手詰み以降も同じことを繰り返すだけであるが、計算時間を考慮して制作した将棋AIでは３手詰みまでとしている。

### 探索部
探索部は将棋でいうところの先読みをする部分である。
現在の局面から数手進んだ先の局面を生成する。
一号機は4手先読み。二号機は基本4手先読みで条件付きで6手先読み。三号機は3手先読みとした。

探索部に必要なものは、主に『駒の動き』『仮想の盤面』『自動で交互に指す仕組み』。
コードの行数としては最も多く書いた部分であり、何度も調整した部分でもある。
盤面は２次元配列を用いて表現し、駒の動ける場所はリストで表した。
駒の動ける位置リストを用いて二次元配列内の駒を動かしている。

先を読めば読むほど良い手が指せるが、計算量が多くなり時間がかかる。
現実的な時間の中で何手先を読めるか工夫する必要があった。
一つの局面に対して可能な候補手は約100手程あり、またそのそれぞれの手を指した局面に対して考えなければならない。
実際、3手先を読むだけで100×100×100＝1000000通りの局面を生成しなければならない。
より先の手を読めるよう、α−β法、候補手の並び替え、事前枝刈りなど様々な工夫を凝らした。
しかし、1手多く先を読めるようになると、新しい問題が生じ、もっと先を読みたくなる。
十数手先を読むことができれば苦労はないが、そこまでの計算量を現実的な時間で読むことはできなかった。
3〜6手先読みを工夫し何度も調整を行った。
5手先に有利になる局面があっても4手先読みでは見つけられない。
3手先読みの時点では有利だが、次の相手のばんに強い駒を取られる。
4手先読みでは有効な手が見つからず千日手になってしまう。
相手にとってとても有利になる手が見つかったら、安い駒を相手に取らせて、4手のうちに相手に良い手を指させないようにする無駄な手数稼ぎをしてしまう。
等の様々な問題を考慮しながら、作る必要があり。また、盤面評価部を改良すれば別の問題が生じる。
何手先を読むかは盤面評価部との相性も考えなければならない。探索部は最後まで完璧と言えるものには出来そうにない。

### 盤面評価部
一般的に評価関数という。
盤面評価部は将棋でいうところの大局観（形成判断）を担う部分であり、
将棋の強さに最も影響する部分である。
盤面を正しく評価することが出来れば、ある局面の優劣がわかり、有利となる手を指すことにつながる。
評価関数の盤面評価基準は、「駒の価値」と「駒の位置関係」に分けられる。
「駒の価値」については、銀が500点、桂馬が400点、飛車が1000点などのように設定し、相手の駒の合計点と自分の駒の合計点の差を調べる。
「駒の位置関係」については、王の隣を金が守っていたら10点、相手の王の行に自分の飛車がいたら50点、自分の桂馬の前に相手の歩があったら-20点のように評価基準と点数を設定し、対象の盤面の合計点を調べる。盤面は以上二つの評価基準によって点数を付けている。
今回の将棋AI制作では駒の価値については全て自分で設定した。
駒の位置関係に対する点数は、一号機、二号機、三号機でそれぞれ異なった作り方をした。

#### 駒の価値について
* 一号機

自分の将棋知識で以下のように各駒に点数を付けた。
何度も検証しながら調整し最終的に以下のようになった。

王（9000）,飛車（1100）,角（900）,金（600）,銀（520）,桂馬（345）,香車（310）,歩（20）
龍（1500）,馬（1200）,成銀（520）,成桂（435）,成香（400）,と金（370）

* 二号機 & 三号機
自分の将棋知識で以下のように各駒に点数を付けた。
駒の価値は調整せずに、二号機を作り始めた時に付けた初期値と変えていない。
三号機も同じ値で制作した。

王（100000）,飛車（700）,角（650）,金（500）,銀（400）,桂馬（250）,香車（230）,歩（80）
龍（1000）,馬（900）,成銀（480）,成桂（470）,成香（450）,と金（490）

#### 駒の位置関係について

* 一号機
王の横に金があれば何点。金の斜め上に銀があれば何点。飛車の前の歩を伸ばしていたら何点。飛車が相手の王と同じ行にいたら何点。
のように思いつく、実際に良いとされる駒の位置関係数十個に点数を付けて評価関数に組み込んだ。
また、逆に金が４段目以上に上がったらマイナス何点。王の近くに守り駒がなければマイナス何点。
のように思いつく、実際に悪いとされる駒の位置関係数個に点数を付けて評価関数に組み込んだ。
しかし、実際自分の将棋知識は乏しく、それぞれの位置関係に点数を付けるのにとても苦労した。
また、全て手打ちのため、多くの位置関係と点数は組め込めなかった。
そのため、一号機での盤面評価値は駒の価値に比重があり、駒の位置関係についてはほとんど影響しなかった。
しかし、実際に強い手を指すには評価関数における駒の位置関係の部分はとても大切な部分である。
プロ棋士も将棋を指す際、駒の価値だけでなく、筋の良い手（駒の連結が良い手。駒の位置関係が良い手。）を考えながら指している。
そこで、二号機以降では機械学習に挑戦し、駒の位置関係についての点数を大規模に自動調整した。

* 二号機
一号機では数十個の位置関係に点数を付けたが、二号機では機械学習によって26244個の位置関係（パラメータ）に点数を付けた。
そしてその位置関係が対象の盤面にあるかを調べその合計点で点数を付ける。
実際のプロのプログラマが作っている将棋AIでは数千万から数億の位置関係の点数を調整しているが、ここではまずは機械学習に挑戦するということで少なめのパラメータ数にした。
26244というのは、『自分の王と自分の駒ひとつの位置関係』からなっている。例えば、王が五九にいる時に、飛車が一一にいるというのがひとつの位置関係。続けて、王が五九にいる時に、飛車が一二にいる。王が五九にいる時に飛車が九九にいる。王が五九にいる時に金が一一にいる。王が五九にいる時に金が一二にいる。王が五九にいる時に桂馬が一一にいる。というように、
王の位置を36、駒の種類を9（飛車、角、金、銀、桂、香、歩、龍、馬）、駒の位置を81として、36×9×810＝26244となっている。この26244のパラメータをどのように調整したかは後述する。

26244と聞くととても多く感じるが、将棋において駒の位置関係に正確に点数を付けるにはあまりも少なすぎたようで、一号機と比べそれほど良い評価関数は作れなかった。しかし、主観ではあるが、良いとされる位置関係には高い点がつき、悪いと思う位置関係には低い点が付けられていたため、学習の仕方はそれなりによく出来ていると思い、三号機では大幅にパラメータ数を増やし機械学習を行った。

* 三号機
二号機では26244の位置関係（パラメータ）に点数を付けたが、三号機では二号機の約2000倍の51963119の位置関係に点数を付けた。
二号機により、ある程度学習効果が見られたので本格的にパラメータ調整に挑戦した。
51963119というのは、『自分の王と相手の王と自分の駒ひとつの3つの駒の位置関係』と『自分の王とその他の駒とその他の駒の3つの駒の位置関係』からなっている。

パラメータの数が2000倍になると、それだけ学習時間もかかる。また、実際の対局でもそれだけ時間がかかる。
実際にこれだけのパラメータを調整するために様々な高速化をはかる必要があった。
結果として26244のパラメータを調整するときよりも早い時間で調整できるようになった。
高速化は主に、パラメータを保存しているファイルの更新頻度を減らしまとめて更新するようにした事、盤面における特徴の有無を何度も盤面を読み込んで調べず、駒の位置から計算で求めるようにした事の二つによって成功した。


## 機械学習
おさらいすると、将棋AIは「詰み判定部」、「探索部」、「盤面評価部（評価関数）」から出来ており。詰み判定部は、詰みの有無を調べる。探索部は、将棋における先読みに相当し、数手先の盤面を生成する役割がある。盤面評価部は、探索部で生成した盤面に点数を付ける。点数を付ける基準は、駒の価値と駒の位置関係の二つである。
機械学習は盤面評価部における駒の位置関係(パラメータ)の点数(重さ)を調整することに用いた。

学習はプロの棋譜を教師データとして行った。棋譜データはpythonのscrapyと言うフレームワークを用いてスクレイピング、クローリングを行い、将棋DB2というサイトから3万棋譜を収集した。将棋DB2のサイトにはjavascriptによる広告が組み込まれていて苦戦したが、seleniumとchromedriverを用いてなんとか集めることができた。収集した棋譜データは「+7776FU,-3334FU,+2726FU,-8384FU,+6978KI,....」のような形式になっている。この棋譜データを再生させ、出現した盤面をデータとして用いた。
棋譜データにその指し手の評価値が載っていればその点数に近づくようにパラメータの値を調整すればいいのだが、棋譜データには指し手しか載っていないため将棋AIが棋士と同じ手を指せるようにパラメータの値を調整した。つまり、ある局面において、棋士が指した手が正解でその他の手は全て不正解という考えでパラメータの値を調整した。ボナンザメソッドと言う方法を自分なりに解釈し自分なりにシンプルに組み立ててみた。

### パラメータの値の更新
まず棋譜を再生させて出現したある局面において、可能な手を全て生成する。
次に、生成した手を指した後の盤面に現在のパラメータの値でそれぞれ点数を付ける。
そして、その局面において棋士が指した手に一番高い点数を付けていれば更新せずに、棋譜をたどる。
もし、棋士が指した手よりも高く評価する手があれば、その手による盤面の駒の位置関係のパラメータの値を減らし、棋士の手による盤面の駒の位置関係のパラメータの値を増やす。

例えば、一番初めの局面であれば、可能な手は「1716FU,2726FU,3736FU,4746FU,5756FU,6766FU,7776FU,8786FU,9796FU,1918KY,9998KY,3938GI,3948GI,7978GI,7968GI,4938KI,4948KI,4958KI,6978KI,6968KI,6958KI,2818HI,2838HI,2848HI,2858HI,2868HI,2878HI,5948OU,5958OU,5968OU」がある。
ここで、学習に用いる棋譜では「7776FU」が指されているとする。
このそれぞれの手について盤面を動かし、その盤面に点数を付ける。
もし、「7776FU」を指した盤面の点数を一番高く付けていれば棋譜の次の手に移る。
もし、「7776FU」を指した盤面の点数よりも「1314FU,2838HI,4958KI」に高い点数を付けていれば、「7776FU」を指した時に現れる位置関係パラメータの値を増やし、「1314FU,2838HI,4958KI」それぞれの手を指した時に現れる位置関係パラメータの値を減らす。この方法により、プロが指した手に現れている駒の位置関係の特徴を高く評価することができ、良い形とされる駒の位置関係を学習することができる。

また、過学習を防ぐための正則化項も自分なりに導入した。

## まとめ
今回の将棋AI制作では、自分の知識を入れるエキスパートシステムと言う手法と、パラメータを自動調整する機械学習の二つの手法で行った。エキスパートシステムでは、様々な条件を考えプログラムに組み込むという経験をし、機械学習ではデータからパラメータを調整するということを経験できた。機械学習については、まだまだ理解が出来ていないことが多いので、必要な数学の知識や、正則化についてや、様々な最適化手法について勉強したいと思う。

また、実際に完成したコードを見てみると、自分では分かるが、他の人にとってはとても読みにくいものになっていた。
原因としては、関数や変数の名前の付け方が良くない事、後から色んな機能を組み込んだ事で、少ししか機能が違わない関数が出来たり、複雑になったりした事が挙げられる。
今後、プログラミング作法や名前の付け方を学び、分かりやすく、改良しやすいプログラムにすることが大切だと改めて感じた。また、コードを書き始める前にもっと細かい設計をする事も大切だと学んだ。
